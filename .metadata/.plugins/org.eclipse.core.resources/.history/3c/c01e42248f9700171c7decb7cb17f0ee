<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="post">
  	<!-- 포스트 쓰기 -->
  	<insert id="write" parameterType="java.util.HashMap">
  		insert into post(num, category, nickname, title, subtitle, fcontent, ccontent, good, 
  					hash, report, pdate, url) 
 					values(post_seq.nextval, #{category}, #{nickname}, #{title}, #{subtitle},
 						#{fcontent}, #{ccontent}, 0, #{hash}, 0, sysdate, #{url})
  	</insert>
  	
  	<!-- 카테고리 목록 가져오기 -->
  	<select id="cate_list" parameterType="java.util.HashMap" resultType="java.util.HashMap">
  		select b.CATEGORY_NAME, b.BLOG_TITLE from blogcategory b where email=#{email}
  	</select>
  	
  	
  	  	
  	
  	<!--(메인) 게시물 전체 불러오기 -->
	<select id="listall" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select tmp3.*,p.nickname as heart from 
		(select tmp2.* from (select rownum as r, tmp.* from (select * from post
		<!-- 태그 -->
		<if test="tag != null">
		where hash=#{keyword}
		</if>
		
		<!-- 검색어 -->
		<if test="post != null">
		where 
		<foreach item="keyword" collection="keyword" separator=" and " open="("
			close=")">
			title like #{keyword} or subtitle like #{keyword} or fcontent like #{keyword} or ccontent like #{keyword}
		</foreach>
		</if>
		
		 order by pdate desc)tmp)tmp2 where tmp2.r between #{first} and #{last}
		)tmp3 left join (select pg.* from postgood pg left join (select nickname as nick from member
		<!-- 좋아요에 하트표시 위한 이메일 검색 -->
		<choose>
		<when test="email != null">
		 where email=#{email}
		</when>
		<otherwise>
		 where email='널값을주기위한아무말'
		</otherwise>
		</choose>
		 )pf on pg.NICKNAME=pf.nick where pf.nick is not null) p on tmp3.num=p.pnum
		</select>
	
	<!-- (메인) 게시물 구독한 게시물 불러오기 -->
	<select id="listLike" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	<if test="email != null">
		select tmp3.*,p.nickname as heart from (
		select tmp2.* from (select rownum as r, tmp.* from
		 (select * from (select p.*,s.EMAIL from post p left join (select * from subscribe where email=#{email}) s on p.url=s.address)tmp where email=#{email} order by pdate desc
		 )tmp)tmp2 where tmp2.r between #{first} and #{last}
		 )tmp3 left join (select pg.* from postgood pg left join (select nickname as nick from member where email=#{email})pf on pg.NICKNAME=pf.nick where pf.nick is not null) p on tmp3.num=p.pnum
	</if>
	</select>
	
	<!-- 게시물 총 갯수 (페이징) -->
	<select id="selectcount" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select count(*) as count from post
		
		<if test="tag != null">
			where hash=#{keyword}
		</if>
		
		<if test="post != null">
			where 
		<foreach item="keyword" collection="keyword" separator=" and " open="("
			close=")">
			title like #{keyword} or subtitle like #{keyword} or fcontent like #{keyword} or ccontent like #{keyword}
		</foreach>
		</if>
		
	</select>
	
	<!-- 게시글 좋아요(게시글좋아요 update) -->
	<update id="postgoodPlus" parameterType="java.util.HashMap">
		update post set good=good+1 where num=#{num}
	</update>
	<insert id="postgoodAdd" parameterType="java.util.HashMap">
		insert into postgood(num, pnum, nickname, pgdate) values(postgood_seq.nextval, #{num}, (select nickname from member where email=#{email}), sysdate)
	</insert>
	
	<update id="postgoodMinus" parameterType="java.util.HashMap">
		update post set good=good-1 where num=#{num}
	</update>
	<delete id="postgoodRemove" parameterType="java.util.HashMap">
		delete from postgood where pnum=#{num} and nickname=(select nickname from member where email=#{email})
	</delete>
  
   <select id="selectHashtag" parameterType="java.lang.String" resultType="java.util.HashMap">
 	  select * from post where hash like #{keyword}
   </select>
  
  
  </mapper>